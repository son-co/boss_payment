<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="app">
      <div class="background gradient">
        <ul class="bg-bubbles">
          <li></li>
          <li></li>
          <li></li>
          <li></li>
          <li></li>
          <li></li>
          <li></li>
          <li></li>
          <li></li>
          <li></li>
        </ul>
      </div>
      <div class="myForm">
        <form id="myForm">
          <input type="text" id="amount" placeholder="Enter amount" /> <br />
          <input type="text" id="order_no" placeholder="Enter order no" />
          <br />
          <button>Submit</button>
        </form>
      </div>
    </div>
  </body>

  <script>
    function showToast(message, duration = 3000) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, duration);
    }
    function extractDataFromBrackets(text) {
    const match = text.match(/\[(.*?)\]/);
    return match ? match[1] : null;
}
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("myForm");

      form.addEventListener("submit", handleSubmit);

      async function handleSubmit(event) {
        event.preventDefault();

        const amount = document.getElementById("amount").value;
        const orderNo = document.getElementById("order_no").value;

        try {
          const signResult = await postRequest(
            "http://m365.ph:8080/api/v1/consumer/public/get-sign",
            { amount: amount, mchOrderNo: orderNo }
          );

          // console.log("Success:", signResult);

          if (signResult) {
            const unifiedOrder = await postRequest(
              "http://www.m365.ph:8029/api/pay/unifiedOrder",
              signResult
            );

            // console.log("Unified Order:", unifiedOrder);

            if(unifiedOrder?.code == 9999){
              showToast(`Error: Merchant order [${extractDataFromBrackets(unifiedOrder?.msg)}] already exists`);
            }

            if (unifiedOrder?.data?.payData) {
              window.location.href = unifiedOrder.data.payData;
            }
          }
        } catch (error) {
          // console.error("Error:", error.message);
          showToast(`Error: An error occurred. Please try again!`);
        }
      }

      async function postRequest(url, data) {
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          throw new Error(`Request failed with status ${response.status}`);
        }

        return response.json();
      }
    });
  </script>
</html>
